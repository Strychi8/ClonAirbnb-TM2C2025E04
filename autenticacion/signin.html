<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Login - Erbienbi</title>
    <link rel="stylesheet" href="../css/styles.css" />
    <link rel="stylesheet" href="../css/formularios.css" />

  </head>

  <body>
    <!-- Header con marquee -->
    <header>
      <div class="marquee-wrapper">
        <h1 class="marquee-text">
          -- üè† üè° -- Erbienbi - El Hospedaje que Buscas, al Mejor Precio -- üè° üè† --
        </h1>
      </div>
    </header>

    <main class="perfil-container">
      <div class="form-links">
        <a href="../index.html"><button type="button" class="btn btn-primary">Ir a la p√°gina principal</button></a>
      </div>

      <div class="perfil-card">
        <div class="perfil-header">
          <h1>Iniciar Sesi√≥n</h1>
        </div>

        <form action="../backend/login.php" method="POST">
          <div id="login-error" role="alert" style="display:none; color:#e5534b; margin-bottom:12px; font-weight:bold; text-align:center; border:1px solid #e5534b;"></div>

          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" name="email" id="email" placeholder="tu@email.com" required>
          </div>

          <div class="form-group">
            <label for="password">Contrase√±a</label>
            <input type="password" name="password" id="password" placeholder="Contrase√±a" required>
          </div>

          <button type="submit" class="btn btn-primary btn-full">Iniciar Sesi√≥n</button>
        </form>

        <div class="registration-link">
          <p>¬øNo tienes una cuenta? <a href="signup.html">Registrarse</a></p>
          <p><a href="recuperar_contrasenia.html">¬øOlvidaste tu contrase√±a?</a></p>
        </div>
      </div>
    </main>

    <!-- Modal de error de login -->
    <div id="loginModal" class="modal" role="alertdialog" aria-modal="true" aria-hidden="true" style="display:none;">
      <div class="modal-content" role="document" style="max-width:480px;">
        <div class="modal-header">
          <h2>Error de autenticaci√≥n</h2>
          <button id="loginModalClose" class="close" aria-label="Cerrar" style="background:none;border:none;font-size:20px;">√ó</button>
        </div>
        <div class="modal-body" style="padding-top:8px; padding-bottom:8px;">
          <p id="loginModalMessage" style="margin:0; color:#b00020; font-weight:bold;">Email o contrase√±a incorrectos.</p>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:8px; padding-top:8px;">
          <button id="loginModalOk" class="btn btn-primary" type="button">Aceptar</button>
        </div>
      </div>
    </div>

    <script src="../js/icono.js"></script>
    <script>
      // Inyectar redirect_url desde localStorage si existe
      document.addEventListener('DOMContentLoaded', function () {
        const redirectUrl = localStorage.getItem('redirect_after_login');
        if (redirectUrl) {
          const form = document.querySelector('form');
          const hiddenInput = document.createElement('input');
          hiddenInput.type = 'hidden';
          hiddenInput.name = 'redirect_url';
          hiddenInput.value = redirectUrl;
          form.appendChild(hiddenInput);
        }
      });

      // Limpiar redirect_after_login si ya se inici√≥ sesi√≥n
      if (window.location.search.includes('success') || document.cookie.includes('logged_in=true')) {
        localStorage.removeItem('redirect_after_login');
      }

      (function authFlow() {
        const params = new URLSearchParams(location.search);
        const error  = params.get('error');
        const emailParam = params.get('email') ? decodeURIComponent(params.get('email')) : '';

        const form       = document.querySelector('form');
        const emailInput = document.getElementById('email');
        const passInput  = document.getElementById('password');

        const modal      = document.getElementById('loginModal');
        const modalTitle = modal?.querySelector('.modal-header h2');
        const modalMsg   = document.getElementById('loginModalMessage');
        const modalClose = document.getElementById('loginModalClose');
        const modalOk    = document.getElementById('loginModalOk');

        const inlineErr  = document.getElementById('login-error');
        const wasDeactivated = (error === 'deactivated'); // guardamos el flag antes de limpiar la URL

        function showInline(msg) { if (inlineErr) { inlineErr.textContent = msg; inlineErr.style.display = 'block'; } }
        function hideInline()    { if (inlineErr) { inlineErr.textContent = ''; inlineErr.style.display = 'none'; } }

        function openModal()  { if (modal) { modal.style.display = 'flex'; modal.setAttribute('aria-hidden','false'); } }
        function closeModal() { if (modal) { modal.style.display = 'none'; modal.setAttribute('aria-hidden','true'); } }
        function setMsg(title, text){ if (modalTitle) modalTitle.textContent = title; if (modalMsg) modalMsg.textContent = text; }

        // Prefill email
        if (emailParam && emailInput) emailInput.value = emailParam;

        // Cerrar modal con X o click fuera
        if (modal) {
          modalClose && (modalClose.onclick = closeModal);
          modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
        }

        // ===== funci√≥n √∫nica para intentar reactivar =====
        async function attemptReactivate() {
          const email = (emailInput?.value || '').trim();
          const password = passInput?.value || '';
          if (!email || !password) {
            closeModal();
            showInline('Ingres√° tu email y contrase√±a para reactivar la cuenta.');
            (email ? passInput : emailInput)?.focus();
            return;
          }
          try {
            hideInline();
            if (modalOk) { modalOk.disabled = true; modalOk.textContent = 'Reactivando...'; }
            const r = await fetch('../backend/reactivar_cuenta.php', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email, password })
            });
            const raw = await r.text();
            let data = null; try { data = JSON.parse(raw); } catch {}
            console.log('reactivar_cuenta.php ‚Üí', r.status, data || raw);

            if (!r.ok || !data || !data.success) {
              const msg = (data && data.message) ? data.message : `No se pudo reactivar (HTTP ${r.status})`;
              closeModal();
              showInline(msg);
              return;
            }
            // OK ‚Üí entrar
            history.replaceState({}, document.title, location.pathname);
            window.location.href = '../index.html';
          } catch (e) {
            closeModal();
            showInline(e.message || 'Error de red al reactivar.');
          } finally {
            if (modalOk) { modalOk.disabled = false; modalOk.textContent = 'Reactivar ahora'; }
          }
        }
        // =================================================

        // Mostrar modal seg√∫n error
        if (error === '1') {
          hideInline();
          setMsg('Error de autenticaci√≥n','Email o contrase√±a incorrectos.');
          modalOk && (modalOk.textContent = 'Aceptar', modalOk.onclick = closeModal);
          openModal();
        } else if (error === 'deactivated') {
          hideInline();
          setMsg('Cuenta desactivada','Tu cuenta est√° desactivada. Pod√©s reactivarla ahora para volver a ingresar.');
          modalOk && (modalOk.textContent = 'Reactivar ahora', modalOk.onclick = attemptReactivate);
          openModal();

          // üîí Interceptar el submit del form mientras est√© desactivada
          if (form) {
            form.addEventListener('submit', function (e) {
              if (!wasDeactivated) return; // si no venimos desactivados, login normal
              e.preventDefault();
              attemptReactivate(); // en lugar de mandar a login.php
            });
          }
        } else if (error === 'deleted') {
          hideInline();
          setMsg('Cuenta eliminada','La cuenta fue eliminada y no puede reactivarse.');
          modalOk && (modalOk.textContent = 'Aceptar', modalOk.onclick = closeModal);
          openModal();
        }

        // Limpiar par√°metros para no reabrir modal al refrescar
        if (error) {
          params.delete('error'); params.delete('email');
          const newUrl = window.location.pathname + (params.toString() ? ('?' + params.toString()) : '');
          window.history.replaceState({}, document.title, newUrl);
        }
      })();
    </script>
  </body>
</html>
